---
# Both testing and production environments
- name: settings.php is present from composer install
  stat:
    path: "{{ drupal_core_path }}/sites/default/settings.php"
  register: composed_settings

- fail:
    msg: "{{ drupal_core_path }}/sites/default/settings.php isn't defined (path doesn't exist)"
  when: composed_settings.stat.exists is not defined

- debug:
    msg: "{{ drupal_core_path }}/sites/default/settings.php is defined OK"
  when: composed_settings.stat.exists is  defined

- name: Ensure Private file directory is present
  file:
    path: "{{ drupal_core_path }}/../private_files"
    state: directory
  become: no

- name: Ensure Drupal's temporary directory is present
  file:
    path: "{{ drupal_core_path }}/../tmp"
    state: directory
  become: no

- name: Ensure Drupal's configuration directory is present
  file:
    path: "{{ drupal_core_path }}/../config"
    state: directory
  become: no

# The following two steps are only used on the dev server

- name: Ensure Dev sql-dump target directory is present
  local_action:
    module: file
    path: "{{ config_dir }}/saved_sql/dev"
    state: directory
  become: no
  tags: ['test_only']

- name: Ensure Live sql-dump target directory is present
  local_action:
    module: file
    path: "{{ config_dir }}/saved_sql/live"
    state: directory
  become: no
  tags: ['test_only']
  
  
# The following steps are only used on the live server
# Both for initial provisioning and 
# ... for updating live code (tag: drupal)

- name: Ensure public files directory is writable by http server
  file:
    path: "{{ drupal_core_path }}/sites/default/files"
    recurse: yes
    state: directory
    owner: "{{drupalvm_webserver_user}}"
    group: "{{drupalvm_webserver_user}}"
    mode: ug+w
  become: yes
  tags: ['drupal', 'prod_only']

- name: Ensure private files directory is writable by http server
  file:
    path: "{{ drupal_core_path }}/../private_files"
    recurse: yes
    state: directory
    owner: "{{drupalvm_webserver_user}}"
    group: "{{drupalvm_webserver_user}}"
    mode: ug+w
  become: yes
  tags: ['drupal', 'prod_only']

- name: Ensure tmp directory is writable by http server
  file:
    path: "{{ drupal_core_path }}/../tmp"
    recurse: yes
    state: directory
    owner: "{{drupalvm_webserver_user}}"
    group: "{{drupalvm_webserver_user}}"
    mode: ug+w
  become: yes
  tags: ['drupal', 'prod_only']

- name: Ensure config directory is writable by http server
  file:
    path: "{{ drupal_core_path }}/../config"
    recurse: yes
    state: directory
    owner: "{{drupalvm_webserver_user}}"
    group: "{{drupalvm_webserver_user}}"
    mode: ug+w
  become: yes
  tags: ['drupal', 'prod_only']
